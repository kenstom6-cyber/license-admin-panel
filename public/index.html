export default {
  async fetch(req, env) {
    // ===== CORS PREFLIGHT =====
    if (req.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: corsHeaders()
      });
    }

    const url = new URL(req.url);

    if (url.pathname === "/activate" && req.method === "POST") {
      return activate(req, env);
    }

    if (url.pathname === "/verify" && req.method === "POST") {
      return verify(req, env);
    }

    if (url.pathname === "/create" && req.method === "POST") {
      return createKey(env);
    }

    if (url.pathname === "/reset" && req.method === "POST") {
      return resetKey(req, env);
    }

    if (url.pathname === "/lock" && req.method === "POST") {
      return lockKey(req, env);
    }

    return json({ error: "Not Found" }, 404);
  }
};

// ===== CORS HEADERS =====
function corsHeaders() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type"
  };
}

function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "Content-Type": "application/json",
      ...corsHeaders()
    }
  });
}

// ===== LOGIC =====
async function activate(req, env) {
  const { licenseKey, hwid } = await req.json();
  const data = await env.LICENSE_DB.get(licenseKey, "json");

  if (!data) return json({ error: "Invalid license" }, 403);
  if (data.revoked) return json({ error: "Revoked" }, 403);

  if (data.activated && data.hwid !== hwid) {
    return json({ error: "Already used" }, 403);
  }

  data.activated = true;
  data.hwid = hwid;
  await env.LICENSE_DB.put(licenseKey, JSON.stringify(data));

  return json({ success: true });
}

async function verify(req, env) {
  const { licenseKey, hwid } = await req.json();
  const data = await env.LICENSE_DB.get(licenseKey, "json");

  if (!data || data.revoked) return json({ valid: false });
  if (data.hwid !== hwid) return json({ valid: false });

  return json({ valid: true });
}

async function createKey(env) {
  const licenseKey = crypto.randomUUID().toUpperCase();
  await env.LICENSE_DB.put(
    licenseKey,
    JSON.stringify({ activated: false, revoked: false })
  );
  return json({ licenseKey });
}

async function resetKey(req, env) {
  const { licenseKey } = await req.json();
  const data = await env.LICENSE_DB.get(licenseKey, "json");

  if (!data) return json({ error: "Not found" }, 404);

  data.activated = false;
  data.hwid = null;
  await env.LICENSE_DB.put(licenseKey, JSON.stringify(data));

  return json({ success: true });
}

async function lockKey(req, env) {
  const { licenseKey } = await req.json();
  const data = await env.LICENSE_DB.get(licenseKey, "json");

  if (!data) return json({ error: "Not found" }, 404);

  data.revoked = true;
  await env.LICENSE_DB.put(licenseKey, JSON.stringify(data));

  return json({ success: true });
}
